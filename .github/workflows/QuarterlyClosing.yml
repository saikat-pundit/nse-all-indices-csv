name: Quarterly Closing

on:
  workflow_dispatch:  # Manual trigger from Actions tab
  schedule:
    - cron: '15 0 1,16 * *'

jobs:
  check-time:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    
    steps:
    - name: Check if current time is within allowed window
      id: check
      run: |
        # Set timezone to IST
        export TZ="Asia/Kolkata"
        
        # Get current hour and minute in IST
        CURRENT_HOUR=$(date +'%H')
        CURRENT_MINUTE=$(date +'%M')
        CURRENT_TIME=$(date +'%H:%M')
        
        # Check if current time is between 00:00 and 05:15
        if [[ "$CURRENT_TIME" < "08:55" ]] || [[ "$CURRENT_TIME" == "08:55" ]]; then
          if [[ "$CURRENT_HOUR" -ge 0 ]]; then
            echo "✅ Current time $CURRENT_TIME IST is within allowed window (00:00-08:55 IST)"
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        # If workflow_dispatch trigger, check time
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "❌ Current time $CURRENT_TIME IST is outside allowed window (00:00-08:55 IST)"
          echo "❌ Manual trigger is only allowed between 00:00 and 08:55 IST"
          echo "allowed=false" >> $GITHUB_OUTPUT
          exit 1
        else
          # For schedule trigger, always allow
          echo "Schedule trigger - bypassing time check"
          echo "allowed=true" >> $GITHUB_OUTPUT
        fi

  process-csv:
    runs-on: ubuntu-latest
    needs: check-time
    if: needs.check-time.outputs.allowed == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Process CSV files and extract data
      run: |
        echo "Processing CSV files..."
        
        # Get current timestamp in IST - IMPORTANT: Set TZ first
        export TZ="Asia/Kolkata"
        TIMESTAMP_IST=$(date +'%d-%b %H:%M')
        
        # Create header for output file
        echo "Index_Name,Closing_Value" > Data/QuarterlyClosing.csv
        
        # Read each required index from BSE.csv
        {
          echo "NIFTY 50"
          echo "FINANCIAL SERVICES"
          echo "BSE Information Technology"
          echo "BSE OIL & GAS"
          echo "AUTO"
          echo "FMCG"
          echo "PHARMA"
          echo "BSE CAPITAL GOODS"
          echo "BSE POWER"
          echo "BSE Consumer Discretionary"
          echo "BSE Telecommunication"
          echo "METAL"
          echo "BSE CONSUMER DURABLES"
          echo "REALTY"
          echo "SERVICES SECTOR"
          echo "BSE India Infrastructure Index"
          echo "BSE Commodities"
        } | while read -r index_name; do
          
          # Try to find in BSE.csv first
          if [ -f "Data/BSE.csv" ]; then
            # Extract second column where first column matches (case-insensitive)
            result=$(awk -F',' -v idx="$index_name" '
            BEGIN {IGNORECASE=1; found=0} 
            $1 ~ idx {print $2; found=1; exit} 
            END {if (!found) print "N/A"}' "Data/BSE.csv")
          else
            result="N/A"
          fi
          
          # If not found in BSE.csv, try nse_all_indices.csv
          if [ "$result" = "N/A" ] || [ -z "$result" ]; then
            if [ -f "Data/nse_all_indices.csv" ]; then
              result=$(awk -F',' -v idx="$index_name" '
              BEGIN {IGNORECASE=1; found=0} 
              $1 ~ idx {print $2; found=1; exit} 
              END {if (!found) print "N/A"}' "Data/nse_all_indices.csv")
            fi
          fi
          
          # Clean the result (remove quotes, extra spaces)
          cleaned_result=$(echo "$result" | sed 's/"//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Append to output file
          echo "\"$index_name\",\"$cleaned_result\"" >> Data/QuarterlyClosing.csv
          
        done
        
        # Add timestamp row at the end (after BSE Commodities)
        echo "\"Update Time (IST):\",\"$TIMESTAMP_IST\"" >> Data/QuarterlyClosing.csv
        
        echo "Data extraction completed at $TIMESTAMP_IST IST!"
        echo "Contents of QuarterlyClosing.csv:"
        cat Data/QuarterlyClosing.csv
        
    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Data/QuarterlyClosing.csv
        
        # Get IST timestamp for commit message - Set TZ again
        export TZ="Asia/Kolkata"
        COMMIT_TIMESTAMP=$(date +'%d-%b-%Y %H:%M IST')
        
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update quarterly closing data - $COMMIT_TIMESTAMP [automated]" && git push)
