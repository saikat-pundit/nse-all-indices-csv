name: Download Google Drive Images

on:
  workflow_dispatch:  # Manual trigger from GitHub UI
  push:
    paths:
      - 'urls.txt'
  schedule:
    - cron: '0 0 * * *'  # Optional: Daily at midnight UTC

jobs:
  download-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Create URLs file
      run: |
        # Create urls.txt with your Google Drive links
        cat > urls.txt << 'EOF'
        https://drive.google.com/file/d/1MiSA5udZTIY3F38DdVn0janYGf2W3Fle/view?usp=drivesdk
        https://drive.google.com/file/d/1MfCvCLPoC9ukYmB_2B2JI3pUma9SFOYZ/view?usp=drivesdk
        https://drive.google.com/file/d/1lUKjWuTy1T_oTE2fz9VSkM_aptH-R4Zv/view?usp=drivesdk
        https://drive.google.com/file/d/1UXnuu4tJq83U-mdOQ9BU6-8oDyYbIfkm/view?usp=drivesdk
        https://drive.google.com/file/d/1_vxs5fw7zavZqDvMnSTNuOt_ghJCWpls/view?usp=drivesdk
        https://drive.google.com/file/d/1DavESr8wwrYInH8pa2AWT89dvQhNUUd9/view?usp=drivesdk
        https://drive.google.com/file/d/1qOAzG1vlZWj57VRR5zwNHxwPlP6aPe1_/view?usp=drivesdk
        https://drive.google.com/file/d/1cSCgbDmweSzZIeLAABP5cUYw01_GDXoM/view?usp=drivesdk
        https://drive.google.com/file/d/1AGmaLasn1cLzaKh7Nj3haH6PXYuOklDJ/view?usp=drivesdk
        https://drive.google.com/file/d/15Xan5i41Dg0bgUqFWbW0y4tllveOTxLe/view?usp=drivesdk
        https://drive.google.com/file/d/1aeOwQn_6lnQunEDWzjo86dNQ0hmP0_Iw/view?usp=drivesdk
        https://drive.google.com/file/d/1BaoTiM2VC1ml4MAyMKfgdu5cPU7W6MNN/view?usp=drivesdk
        https://drive.google.com/file/d/1LUOkkBVqJfFIksJNwydwD-YkW4EB1ANU/view?usp=drivesdk
        https://drive.google.com/file/d/1CH5tcGracW31B2BrJi36KrwRVbYOIZl7/view?usp=drivesdk
        https://drive.google.com/file/d/1mILZQWlwBTiK8DxnZmwwWZ6xe3FRD4qu/view?usp=drivesdk
        https://drive.google.com/file/d/1I5xjErhK1HnGpVZRGZ_oi5AWEtg-Fbc6/view?usp=drivesdk
        https://drive.google.com/file/d/1_EKmqv8faoMyCEZXp-w4ej8yakonTI8a/view?usp=drivesdk
        https://drive.google.com/file/d/1eGrDHIHXNmtFozFL0sFtdgUN_xVVKQuH/view?usp=drivesdk
        https://drive.google.com/file/d/1ppRohfHo1emzYTdxAINIPsNtS2zUmfq6/view?usp=drivesdk
        https://drive.google.com/file/d/1MrmuUTX2aaoP0peJ_hFuVeQOzHTp-ZI9/view?usp=drivesdk
        https://drive.google.com/file/d/18-QWX_WpD8WUxhY-yGN33XTaXMbEz4yZ/view?usp=drivesdk
        https://drive.google.com/file/d/1_vKrf86Lp8ZcYnnmpfvEyQMKlkFTxzbC/view?usp=drivesdk
        https://drive.google.com/file/d/1aP6BuuR3HH1U9_MgdeUvlbm87KCI9zIz/view?usp=drivesdk
        https://drive.google.com/file/d/1LNfCkM-EqwsBdN5bZApoqr8VotaSRPI6/view?usp=drivesdk
        https://drive.google.com/file/d/1ovbVKXpw5UQcMFzuwUGv_CIGZZfEGabp/view?usp=drivesdk
        https://drive.google.com/file/d/121ywYjI-WxF2xEzOunulbxY59g6MWZHA/view?usp=drivesdk
        https://drive.google.com/file/d/1zmNfIJ2R6B3XOG59ntM2kqR-5BuIbjr8/view?usp=drivesdk
        https://drive.google.com/file/d/1TTEAu3hrb0oYFVh0yQMkAKu0Hk6gksef/view?usp=drivesdk
        https://drive.google.com/file/d/1FDDf8maIBRNPJRE0P_YNbqLywLMiUHij/view?usp=drivesdk
        https://drive.google.com/file/d/1wT4GV095ff8l-03CbHLJHzQKEzQ89f4E/view?usp=drivesdk
        https://drive.google.com/file/d/18_BCY3IHTjAC1LGWpefl_YMVSxlvFH7k/view?usp=drivesdk
        https://drive.google.com/file/d/1vc4oIihRF4fbkFV36RnQIr1ed7s0gpmH/view?usp=drivesdk
        https://drive.google.com/file/d/1hscMzlYQUGW1qigBYRHZlBlDga12fJ3-/view?usp=drivesdk
        https://drive.google.com/file/d/1e8birAHRaMJrOtlsa8Hrh4JNIw_cWaiR/view?usp=drivesdk
        https://drive.google.com/file/d/1AsndB6iATylKVfnPzBy0_NDF0GgOZ-02/view?usp=drivesdk
        https://drive.google.com/file/d/16RwLfMLLiedN_oKelIZyjItgA5Mk1-ds/view?usp=drivesdk
        https://drive.google.com/file/d/16j6ThviltCwSOkejoEtn8_e_e7xcDnNS/view?usp=drivesdk
        https://drive.google.com/file/d/1nFwhP0Ow0qMXE5uQ5-R5fHE1jKBqgW1e/view?usp=drivesdk
        https://drive.google.com/file/d/1sBHAxZQ_nma7mTAlzFMPSJPlEM2UaO6X/view?usp=drivesdk
        https://drive.google.com/file/d/1yhXw8gvb2nCby6kBntMCG_jkm5NT7pi6/view?usp=drivesdk
        https://drive.google.com/file/d/1jwEkDcHEMTN6bLkA7OQJo_3NuNGnzJuB/view?usp=drivesdk
        https://drive.google.com/file/d/1TVlCLOaST5b7vylsLr9AkCi5_pCssKYb/view?usp=drivesdk
        https://drive.google.com/file/d/1wSNpMhuqwlK0n3HCC8cYSULFuWOtH30c/view?usp=drivesdk
        https://drive.google.com/file/d/1wai85wX7f6A9mlts3RU-8p2-lkspIAOU/view?usp=drivesdk
        https://drive.google.com/file/d/1Q-yFsScIi_237sI8EkCsfcMEp-jT4nRT/view?usp=drivesdk
        https://drive.google.com/file/d/1BTmqElycyEfhZZazpwCjfD-XR6ZYNYZ9/view?usp=drivesdk
        https://drive.google.com/file/d/1VQVf8hMUb5JnK5r8mwDZ2ToIZ_SO3JXy/view?usp=drivesdk
        https://drive.google.com/file/d/1_7Qzp69eL1iry54BvSz2mX9Bt8emNYRP/view?usp=drivesdk
        https://drive.google.com/file/d/1zgrY99G3tI_AVTx3ItHGGpEpXwB9pLfs/view?usp=drivesdk
        https://drive.google.com/file/d/1gqn3DAVTarqKt8phcAdmfie55OtMxVSN/view?usp=drivesdk
        https://drive.google.com/file/d/12KeXdwHFlfv3G-em6lfK5UF4j5W2XRem/view?usp=drivesdk
        https://drive.google.com/file/d/1WM1pZRkGHEX7N4qJHGoxH8j2DujTEMbb/view?usp=drivesdk
        https://drive.google.com/file/d/12RihZNsLNZXhCNC3fAnREghhXoJsSeNz/view?usp=drivesdk
        https://drive.google.com/file/d/1udWEJVrHqKvKLpSrTes-ZQ1nP7FAtixB/view?usp=drivesdk
        https://drive.google.com/file/d/1Xl3_bzERgpL5Jt720vapTvloC29gkSzG/view?usp=drivesdk
        https://drive.google.com/file/d/1_gitRFlBU1sdgS0uAQD6Kx6k_uTezk_u/view?usp=drivesdk
        https://drive.google.com/file/d/12c4XrX1CXtWNumdQ71ga_jO4u4xR1voY/view?usp=drivesdk
        https://drive.google.com/file/d/1CFfnKdq8bcEz-MBSzZJyX6IPA0Qgl6Cn/view?usp=drivesdk
        https://drive.google.com/file/d/1ecYHSw1GfQ4t5mfwidJi1YT7UqjGw69Q/view?usp=drivesdk
        https://drive.google.com/file/d/1cOH7YNpVdhYNwEpvWHmeyYk7E0lYWWbd/view?usp=drivesdk
        https://drive.google.com/file/d/1s1OvpznJ_JWskfIfQtdGOLVoHO0MOjeZ/view?usp=drivesdk
        https://drive.google.com/file/d/1jRvAdhN06Cde70QSs_xu-h4TRGS3fRN8/view?usp=drivesdk
        https://drive.google.com/file/d/1bycgTUd1K89xwIcJUoRPSKBfxM9Wi_gw/view?usp=drivesdk
        https://drive.google.com/file/d/1mc0WPsk_nEgewASvrwVOnb-ErX3iJuC8/view?usp=drivesdk
        EOF
        
    - name: Run download script
      run: |
        python gdrive_image_downloader.py -i urls.txt -o gdrive_images.zip -w 3
        - name: Create Python script
      run: |
        cat > gdrive_image_downloader.py << 'EOF'
        import os
        import requests
        import zipfile
        import re
        from urllib.parse import urlparse, unquote
        import concurrent.futures
        import time
        import argparse
        
        class GoogleDriveDownloader:
            def __init__(self, urls_file='urls.txt', output_zip='gdrive_images.zip', max_workers=3):
                self.urls_file = urls_file
                self.output_zip = output_zip
                self.max_workers = max_workers
                self.successful_downloads = 0
                self.failed_downloads = 0
                self.session = requests.Session()
                
            def extract_file_id(self, url):
                patterns = [
                    r'/file/d/([a-zA-Z0-9_-]+)',
                    r'id=([a-zA-Z0-9_-]+)',
                    r'/([a-zA-Z0-9_-]{25,})/view'
                ]
                
                for pattern in patterns:
                    match = re.search(pattern, url)
                    if match:
                        return match.group(1)
                return None
            
            def get_direct_download_url(self, file_id):
                return f"https://drive.google.com/uc?export=download&id={file_id}"
            
            def get_filename_from_headers(self, response):
                content_disposition = response.headers.get('content-disposition', '')
                if 'filename=' in content_disposition:
                    filename = re.findall('filename="?([^"]+)"?', content_disposition)
                    if filename:
                        return unquote(filename[0])
                return None
            
            def download_gdrive_file(self, url_index_pair):
                url, index = url_index_pair
                
                try:
                    print(f"Processing ({index + 1}): {url[:60]}...")
                    
                    file_id = self.extract_file_id(url)
                    if not file_id:
                        print(f"✗ Could not extract file ID from URL {index + 1}")
                        return {'index': index, 'url': url, 'success': False, 'error': 'Invalid Google Drive URL'}
                    
                    direct_url = self.get_direct_download_url(file_id)
                    
                    headers = {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                    
                    response = self.session.get(direct_url, headers=headers, timeout=30, stream=True)
                    
                    if 'Google Drive - Virus scan warning' in response.text:
                        confirm_match = re.search(r'confirm=([a-zA-Z0-9_-]+)', response.text)
                        if confirm_match:
                            confirm_token = confirm_match.group(1)
                            download_url = f"https://drive.google.com/uc?export=download&id={file_id}&confirm={confirm_token}"
                            response = self.session.get(download_url, headers=headers, timeout=30, stream=True)
                    
                    response.raise_for_status()
                    
                    content = response.content
                    
                    filename = self.get_filename_from_headers(response)
                    if not filename:
                        filename = f"gdrive_file_{file_id[:10]}.jpg"
                    
                    print(f"✓ Downloaded ({index + 1}): {filename}")
                    
                    return {
                        'index': index,
                        'url': url,
                        'file_id': file_id,
                        'filename': filename,
                        'content': content,
                        'success': True
                    }
                    
                except requests.exceptions.RequestException as e:
                    print(f"✗ Failed to download URL {index + 1}: {e}")
                    return {
                        'index': index,
                        'url': url,
                        'success': False,
                        'error': str(e)
                    }
                except Exception as e:
                    print(f"✗ Error processing URL {index + 1}: {e}")
                    return {
                        'index': index,
                        'url': url,
                        'success': False,
                        'error': str(e)
                    }
            
            def read_urls(self):
                try:
                    if ',' in self.urls_file and not os.path.exists(self.urls_file):
                        urls = [url.strip() for url in self.urls_file.split(',') if url.strip()]
                        print(f"Found {len(urls)} URLs in input string")
                        return urls
                    else:
                        with open(self.urls_file, 'r') as file:
                            content = file.read()
                            if ',' in content:
                                urls = [url.strip() for url in content.split(',') if url.strip()]
                            else:
                                urls = [line.strip() for line in content.split('\n') if line.strip()]
                        print(f"Found {len(urls)} URLs in {self.urls_file}")
                        return urls
                except FileNotFoundError:
                    print(f"Note: File '{self.urls_file}' not found. Using as URL string.")
                    if ',' in self.urls_file:
                        urls = [url.strip() for url in self.urls_file.split(',') if url.strip()]
                        print(f"Found {len(urls)} URLs in input string")
                        return urls
                    return []
            
            def create_zip(self, downloaded_files):
                try:
                    with zipfile.ZipFile(self.output_zip, 'w', zipfile.ZIP_DEFLATED) as zipf:
                        for file_data in downloaded_files:
                            if file_data['success'] and file_data.get('content'):
                                filename = file_data['filename']
                                counter = 1
                                original_filename = filename
                                while filename in zipf.namelist():
                                    name, ext = os.path.splitext(original_filename)
                                    filename = f"{name}_{counter}{ext}"
                                    counter += 1
                                
                                zipf.writestr(filename, file_data['content'])
                                self.successful_downloads += 1
                            else:
                                self.failed_downloads += 1
                    
                    return True
                except Exception as e:
                    print(f"Error creating zip file: {e}")
                    return False
            
            def run(self):
                print("=" * 70)
                print("GOOGLE DRIVE IMAGE DOWNLOADER")
                print("=" * 70)
                
                urls = self.read_urls()
                if not urls:
                    print("No URLs found to process.")
                    return
                
                url_pairs = [(url, idx) for idx, url in enumerate(urls)]
                
                print(f"\nStarting download of {len(urls)} Google Drive files...")
                print(f"Concurrent downloads: {self.max_workers}\n")
                
                downloaded_files = []
                with concurrent.futures.ThreadPoolExecutor(max_workers=self.max_workers) as executor:
                    future_to_url = {executor.submit(self.download_gdrive_file, pair): pair for pair in url_pairs}
                    
                    for future in concurrent.futures.as_completed(future_to_url):
                        result = future.result()
                        downloaded_files.append(result)
                
                downloaded_files.sort(key=lambda x: x['index'])
                
                print(f"\nCreating zip file: {self.output_zip}")
                if self.create_zip(downloaded_files):
                    print(f"\n✅ SUCCESS!")
                    print(f"  - Output file: {self.output_zip}")
                    print(f"  - Downloaded: {self.successful_downloads} files")
                    print(f"  - Failed: {self.failed_downloads} files")
                    
                    try:
                        file_size = os.path.getsize(self.output_zip) / (1024 * 1024)
                        print(f"  - Zip file size: {file_size:.2f} MB")
                    except:
                        pass
                else:
                    print(f"\n❌ Failed to create zip file")
        
        def main():
            parser = argparse.ArgumentParser(description='Download images/files from Google Drive URLs')
            parser.add_argument('-i', '--input', default='urls.txt', help='Input file with URLs')
            parser.add_argument('-o', '--output', default='gdrive_images.zip', help='Output zip file name')
            parser.add_argument('-w', '--workers', type=int, default=3, help='Number of concurrent downloads')
            
            args = parser.parse_args()
            
            downloader = GoogleDriveDownloader(
                urls_file=args.input,
                output_zip=args.output,
                max_workers=args.workers
            )
            
            downloader.run()
        
        if __name__ == "__main__":
            main()
        EOF  
    - name: Upload zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: gdrive-images
        path: gdrive_images.zip
        retention-days: 7
        
    - name: Get file size
      run: |
        if [ -f gdrive_images.zip ]; then
          size=$(du -h gdrive_images.zip | cut -f1)
          echo "Zip file size: $size"
        fi
